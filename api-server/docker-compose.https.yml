services:
  api-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: pingmailer-api-server
    restart: unless-stopped
    
    # HTTPS mode
    ports:
      - "8443:8443"
    
    environment:
      - PORT=8443
      - CERT_FILE=/certs/live/${DOMAIN}/fullchain.pem
      - KEY_FILE=/certs/live/${DOMAIN}/privkey.pem
      - OAUTH2_TOKEN_URL=${OAUTH2_TOKEN_URL:-https://localhost:8090/oauth2/token}
      - OAUTH2_INTROSPECT_URL=${OAUTH2_INTROSPECT_URL:-https://localhost:8090/oauth2/introspect}
      - OAUTH2_CLIENT_ID=${OAUTH2_CLIENT_ID}
      - OAUTH2_CLIENT_SECRET=${OAUTH2_CLIENT_SECRET}
    
    # Mount entire certbot etc directory to preserve symlinks
    # This allows Docker to follow the symlinks to the archive directory
    volumes:
      - ${CERT_PATH}:/certs:ro
    
    # Join the mail network to integrate with mail services
    networks:
      - mail-network

networks:
  mail-network:
    external: true
